{% extends "admin/admin.html" %}

{% block navbar %}
{{ super() }}

<style type="text/css">

  .summary {
    text-align: right;
  }

  #hails th, #hails td {
    border: 1px solid black;
    padding: 5px;
  }

  .customer-requests {
    display: flex;
  }

  .phone, .hails {
    margin: 10px;
    padding: 10px;
  }

  .phone {
    min-width: 130px;
  }

  .hails {
    display: flex;
    flex-wrap: wrap;
  }

  .hails-failure {
    border-left: 5px solid rgba(255, 0, 0, 0.4);
  }

  .hails-success {
    border-left: 5px solid rgba(0, 150, 0, 0.4);
  }

  .hail {
    border: 1px solid #aaa;
    margin: 5px;
  }

  .hail .hail-title {
    background-color: rgba(255, 0, 0, 0.4);
    font-weight: bold;
    padding: 20px;
    text-align: center;
  }

  {% for status in success_status %}
  .hail.{{ status }} .hail-title {
    background-color: rgba(0, 150, 0, 0.4);
  }
  {% endfor %}

  .hail-content {
    padding: 20px;
  }

  .hail-content ul {
    list-style-type: none;
    margin: 0px;
    padding: 0px;
  }

  .hail-details {
    display: none;
  }
</style>

<script type="text/javascript">

  function displayHail(node) {
    node.style.display = node.style.display == 'block' ? 'none' : 'block';
  }
</script>

{% endblock %}

{% block content %}
{{ super() }}

<div class="container">
    <h1>Filters</h1>

    <form method="get">
      <p>
        Afficher les requêtes du <input type="date" id="start" name="start" value="{{ start.strftime('%Y-%m-%d') }}" /> jusqu'à la fin du mois
      </p>
      <p>
        <input type="submit" />
      </p>
    </form>


{% for group in customers_requests | groupby('data.date') | reverse %}

  <h2>{{ group.grouper }}</h2>

  <div class="summary">
    <strong>
      Courses ok : {{ group.list | selectattr('success', 'equalto', True) | list | count  }}/{{ group.list | selectattr('success', 'equalto', False) | list | count  }}
      ({{ '%.f' % ((group.list | selectattr('success', 'equalto', True) | list | count) * 100 / (group.list | selectattr('success', 'equalto', False) | list | count)) }}%)
    <strong>
  </div>

  {% for req in group.list %}
    <div class="customer-requests">
      <div class="phone">{{ req.data.phone }}</div>

      <div class="hails hails-{{ 'success' if req.success else 'failure' }}">
        {% for hail in req.data.hails %}
        <div class="hail {{ hail.status }}">
          <div class="hail-title">
            {{ (hail.added_at | str_to_datetime).strftime('%H:%M:%S') }}
            <br />
            Opérateur: {{ hail.operator.commercial_name }}
            <br />
            Course par: {{ hail.added.commercial_name or hail.added.email }}
            <br />
            {{ hail.status }}
        </div>
          <div class="hail-content">
            <ul>
              <li><strong>Taxi:</strong> {{ hail.taxi_id }}</li>
              <li>
                <a href="#{{ hail.id }}" onclick="displayHail(this.parentNode.children[1]);">...</a>
                <div class="hail-details">
                  <ul>
                  {% for key, value in hail.items() %}
                    <li><strong>{{ key }}:</strong> {{ value }}</li>
                  {% endfor %}
                  </ul>
                </div>
              </li>
            </ul>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
{% endfor %}
</div>

{% endblock %}
